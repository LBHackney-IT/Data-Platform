name: AWS Account Bootstrap
on:
  workflow_dispatch:
    inputs:
      aws_account_id:
        description: 'AWS Account Id'
        required: true
      aws_account_name:
        description: 'AWS Account Name'
        required: true
      aws_account_ou_id:
        description: 'AWS Account OU Id'
        required: true
      aws_account_ou_name:
        description: 'AWS Account OU Name'
        required: true

jobs:
  build:
    name: AWS Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v2
      - name: Add GitHub Account Secret  
        uses: gliech/create-github-secret-action@v1
        with:
          name: 'AWS_ACCOUNT_${{ github.event.inputs.aws_account_name }}'
          value: ${{ github.event.inputs.aws_account_id }}
          pa_token: ${{ secrets.GH_PAT }}
      - name: Setup Account Terraform
        uses: cuchi/jinja2-action@v1.2.0
        with:
          template: platform/account-bootstrap/terraform/00-init.tf
          output_file: platform/00-init.tf
          strict: true
          variables: |
            aws_account_id=${{ github.event.inputs.aws_account_id }}
            aws_account_name=${{ github.event.inputs.aws_account_name }}
            aws_account_ou_id=${{ github.event.inputs.aws_account_ou_id }}
            aws_account_ou_name=${{ github.event.inputs.aws_account_ou_name }}    
      - name: Commit Changes
        uses: github-actions-x/commit@v2.8
        with:
          github-token: ${{ secrets.GH_PAT }}
          push-branch: 'master'
          commit-message: 'AWS Account Bootstrap (${{ github.event.inputs.aws_account_id }})'
          force-add: 'true'
          files: platform/00-init.tf
